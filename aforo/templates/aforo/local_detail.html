{% extends 'base.html' %}
{% load static %}

{% block title %}Detalle Local - AFORIX{% endblock %}

{% block content %}
<div class="container">
  <!-- Botón volver -->
  <a href="{% url 'lista_locales' %}" class="btn btn-outline-primary mb-4 fade-in">
    <i class="fas fa-arrow-left"></i> Volver a Locales
  </a>

  <!-- Header del Local -->
  <div class="detail-header fade-in">
    <div>
      <h1 class="detail-title" id="nombreLocal">
        <i class="fas fa-building"></i> <span>Cargando...</span>
      </h1>
      <p class="text-muted mb-0" id="localDireccion">---</p>
    </div>

    <div class="d-flex gap-2">
      <a id="btnReportes" href="#" class="btn btn-success">
        <i class="fas fa-chart-bar"></i> Reportes
      </a>
      <button onclick="eliminarLocal()" class="btn btn-danger">
        <i class="fas fa-trash"></i> Eliminar
      </button>
    </div>
  </div>

  <!-- Tarjetas de Estadísticas -->
  <div class="stats-grid">
    <div class="stat-card fade-in">
      <div class="stat-icon">
        <i class="fas fa-users text-primary"></i>
      </div>
      <div class="stat-label">Aforo Actual</div>
      <div class="stat-value" id="aforoActual">...</div>
      <div class="text-muted" style="font-size: 0.875rem; margin-top: 0.5rem;">
        <i class="fas fa-clock"></i> <span id="ultimaActualizacion">Actualizando...</span>
      </div>
    </div>

    <div class="stat-card fade-in">
      <div class="stat-icon">
        <i class="fas fa-door-open text-info"></i>
      </div>
      <div class="stat-label">Capacidad Máxima</div>
      <div class="stat-value" id="capacidad">...</div>
      <div class="text-muted" style="font-size: 0.875rem; margin-top: 0.5rem;">
        Personas permitidas
      </div>
    </div>

    <div class="stat-card fade-in">
      <div class="stat-icon">
        <i class="fas fa-percentage text-warning"></i>
      </div>
      <div class="stat-label">Ocupación</div>
      <div class="stat-value" id="porcentajeOcupacion">0%</div>
      
      <!-- Barra de Progreso Responsive -->
      <div class="progress-container" style="margin-top: 1rem; height: 32px;">
        <div 
          id="barraOcupacion" 
          class="progress-bar" 
          role="progressbar"
          style="width: 0%; min-width: 20px;"
        ></div>
      </div>
      
      <div class="mt-2" id="estadoOcupacion">
        <span class="badge bg-success">
          <i class="fas fa-check-circle"></i> Normal
        </span>
      </div>
    </div>
  </div>

  <!-- Estado del Dispositivo ESP32 -->
  <div class="device-status-card fade-in">
    <h3 class="mb-4">
      <i class="fas fa-microchip"></i> Estado del Dispositivo (ESP32)
    </h3>
    
    <div class="device-status-item">
      <div>
        <strong><i class="fas fa-network-wired"></i> Origen del Dato</strong>
      </div>
      <div>
        <span class="status-indicator online"></span>
        <span id="origenUltimo">---</span>
      </div>
    </div>
    
    <div class="device-status-item">
      <div>
        <strong><i class="fas fa-clock"></i> Última Conexión</strong>
      </div>
      <div id="ultimaConexion">---</div>
    </div>
    
    <div class="device-status-item">
      <div>
        <strong><i class="fas fa-sync-alt"></i> Frecuencia de Actualización</strong>
      </div>
      <div>
        <span class="badge bg-info">Cada 3 segundos</span>
      </div>
    </div>
  </div>

  <!-- Historial de Aforo -->
  <div class="historial-container fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="mb-0">
        <i class="fas fa-history"></i> Historial de Aforo
      </h3>
      <span class="badge bg-secondary" id="historialCount">Cargando...</span>
    </div>
    <div id="historial">
      <div class="text-center py-5">
        <div class="spinner"></div>
        <p class="mt-3 text-muted">Cargando historial...</p>
      </div>
    </div>
  </div>
</div>

<script id="local_id" type="application/json">{{ local_id }}</script>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Verificar autenticación
  if (!aforix.auth.isAuthenticated()) {
    window.location.href = '/login/';
    return;
  }

  const localId = JSON.parse(document.getElementById('local_id').textContent);
  let capacidadMaxima = 0;
  let intervaloActualizacion = null;

  // Cargar datos del local
  async function cargarNombreLocal() {
    try {
      const l = await aforix.api.get(`/api/locales/${localId}/`);
      
      document.getElementById('nombreLocal').innerHTML = `
        <i class="fas fa-building"></i> <span>${l.nombre}</span>
      `;
      document.getElementById('localDireccion').textContent = l.direccion || 'Sin dirección';
      document.getElementById('capacidad').textContent = l.aforo_max;
      capacidadMaxima = l.aforo_max;

      document.getElementById("btnReportes").href = `/reportes/${localId}/`;
    } catch (error) {
      console.error('Error cargando local:', error);
      aforix.utils.showNotification('Error cargando datos del local', 'error');
    }
  }

  // Cargar último registro y actualizar barra
  async function cargarUltimo() {
    try {
      const data = await aforix.api.get(`/api/locales/${localId}/ultimo/`);
      
      const aforoActual = data.aforo ?? 0;
      document.getElementById('aforoActual').textContent = aforoActual;
      document.getElementById('origenUltimo').textContent = data.origen || '---';
      
      const fechaConexion = data.timestamp 
        ? aforix.utils.formatDate(data.timestamp)
        : '---';
      document.getElementById('ultimaConexion').textContent = fechaConexion;
      document.getElementById('ultimaActualizacion').textContent = 'Actualizado ahora';

      if (capacidadMaxima > 0) {
        const porcentaje = Math.round((aforoActual / capacidadMaxima) * 100);
        
        // Actualizar porcentaje
        document.getElementById("porcentajeOcupacion").textContent = porcentaje + "%";
        
        // Actualizar barra de progreso con animación
        aforix.progressBar.update('barraOcupacion', porcentaje, {
          animate: true,
          showLabel: true,
          minWidth: 20
        });
        
        // Actualizar estado visual
        const estadoContainer = document.getElementById('estadoOcupacion');
        let estadoHTML = '';
        
        if (porcentaje >= 90) {
          estadoHTML = `
            <span class="badge bg-danger">
              <i class="fas fa-exclamation-triangle"></i> Lleno
            </span>
          `;
        } else if (porcentaje >= 60) {
          estadoHTML = `
            <span class="badge bg-warning">
              <i class="fas fa-exclamation-circle"></i> Ocupado
            </span>
          `;
        } else {
          estadoHTML = `
            <span class="badge bg-success">
              <i class="fas fa-check-circle"></i> Normal
            </span>
          `;
        }
        
        estadoContainer.innerHTML = estadoHTML;
        
        // Efecto de alerta si está lleno
        if (porcentaje >= 90) {
          document.getElementById('barraOcupacion').classList.add('glow-effect');
        } else {
          document.getElementById('barraOcupacion').classList.remove('glow-effect');
        }
      }
    } catch (error) {
      console.error('Error cargando último aforo:', error);
    }
  }

  // Cargar historial
  async function cargarHistorial() {
    try {
      const arr = await aforix.api.get(`/api/aforos/?local=${localId}`);
      const cont = document.getElementById('historial');
      
      document.getElementById('historialCount').textContent = `${arr.length} registros`;

      if (arr.length === 0) {
        cont.innerHTML = `
          <div class="text-center py-5">
            <i class="fas fa-inbox" style="font-size: 3rem; color: var(--text-muted);"></i>
            <p class="mt-3 text-muted">No hay registros aún</p>
          </div>
        `;
        return;
      }

      cont.innerHTML = '';
      
      arr.slice(0, 30).forEach((r, index) => {
        const item = document.createElement('div');
        item.className = 'historial-item fade-in';
        item.style.animationDelay = `${index * 0.05}s`;
        
        const fecha = aforix.utils.formatDate(r.timestamp);
        const porcentaje = capacidadMaxima > 0 
          ? Math.round((r.aforo / capacidadMaxima) * 100)
          : 0;
        
        let badgeClass = 'bg-success';
        if (porcentaje >= 90) badgeClass = 'bg-danger';
        else if (porcentaje >= 60) badgeClass = 'bg-warning';
        
        item.innerHTML = `
          <div>
            <div class="historial-time">
              <i class="fas fa-clock"></i> ${fecha}
            </div>
            <div class="text-muted" style="font-size: 0.875rem;">
              <i class="fas fa-microchip"></i> ${r.origen || '---'}
            </div>
          </div>
          <div class="text-end">
            <div class="historial-value">${r.aforo}</div>
            <span class="badge ${badgeClass}" style="font-size: 0.75rem;">
              ${porcentaje}%
            </span>
          </div>
        `;
        
        cont.appendChild(item);
      });
    } catch (error) {
      console.error('Error cargando historial:', error);
      document.getElementById('historial').innerHTML = `
        <div class="text-center py-5">
          <i class="fas fa-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
          <p class="mt-3 text-danger">Error cargando historial</p>
        </div>
      `;
    }
  }

  // Eliminar local
  window.eliminarLocal = async function() {
    if (!confirm("¿Seguro que deseas eliminar este local? Esta acción no se puede deshacer.")) {
      return;
    }

    try {
      aforix.utils.showLoading();
      await aforix.api.delete(`/api/locales/${localId}/`);
      aforix.utils.showNotification('Local eliminado correctamente', 'success');
      
      setTimeout(() => {
        window.location.href = '/';
      }, 1000);
    } catch (error) {
      console.error('Error eliminando local:', error);
      aforix.utils.showNotification('Error al eliminar el local', 'error');
    } finally {
      aforix.utils.hideLoading();
    }
  };

  // Inicializar
  async function inicializar() {
    await cargarNombreLocal();
    await cargarUltimo();
    await cargarHistorial();

    // Actualizar cada 3 segundos
    intervaloActualizacion = setInterval(() => {
      cargarUltimo();
    }, 3000);
  }

  // Limpiar intervalo al salir
  window.addEventListener('beforeunload', () => {
    if (intervaloActualizacion) {
      clearInterval(intervaloActualizacion);
    }
  });

  inicializar();
});
</script>
{% endblock %}
